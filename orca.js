(()=>{var t={786:t=>{t.exports={from:t=>t}},724:(t,s,i)=>{var e=i(187);let o=window.top.ports;o||(o=window.top.ports={});class n extends e{bind(t){this.port=t,o[t]=this,this.emit("listening")}address(){return{address:"0.0.0.0",port:this.port}}send(t,s,i,e){const n=o[s];n||e(new Error("Unable to connect")),n.emit("message",t)}close(){this.removeAllListeners(),this.port&&o[this.port]===this&&delete o[this.port]}}t.exports={createSocket:()=>new n}},224:t=>{t.exports={remote:{dialog:{}}}},500:t=>{t.exports=!1},187:t=>{"use strict";var s,i="object"==typeof Reflect?Reflect:null,e=i&&"function"==typeof i.apply?i.apply:function(t,s,i){return Function.prototype.apply.call(t,s,i)};s=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var o=Number.isNaN||function(t){return t!=t};function n(){n.init.call(this)}t.exports=n,t.exports.once=function(t,s){return new Promise((function(i,e){function o(){void 0!==n&&t.removeListener("error",n),i([].slice.call(arguments))}var n;"error"!==s&&(n=function(i){t.removeListener(s,o),e(i)},t.once("error",n)),t.once(s,o)}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var r=10;function h(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?n.defaultMaxListeners:t._maxListeners}function a(t,s,i,e){var o,n,r,a;if(h(i),void 0===(n=t._events)?(n=t._events=Object.create(null),t._eventsCount=0):(void 0!==n.newListener&&(t.emit("newListener",s,i.listener?i.listener:i),n=t._events),r=n[s]),void 0===r)r=n[s]=i,++t._eventsCount;else if("function"==typeof r?r=n[s]=e?[i,r]:[r,i]:e?r.unshift(i):r.push(i),(o=c(t))>0&&r.length>o&&!r.warned){r.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=t,l.type=s,l.count=r.length,a=l,console&&console.warn&&console.warn(a)}return t}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function u(t,s,i){var e={fired:!1,wrapFn:void 0,target:t,type:s,listener:i},o=l.bind(e);return o.listener=i,e.wrapFn=o,o}function p(t,s,i){var e=t._events;if(void 0===e)return[];var o=e[s];return void 0===o?[]:"function"==typeof o?i?[o.listener||o]:[o]:i?function(t){for(var s=new Array(t.length),i=0;i<s.length;++i)s[i]=t[i].listener||t[i];return s}(o):f(o,o.length)}function d(t){var s=this._events;if(void 0!==s){var i=s[t];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function f(t,s){for(var i=new Array(s),e=0;e<s;++e)i[e]=t[e];return i}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return r},set:function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");r=t}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||o(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},n.prototype.getMaxListeners=function(){return c(this)},n.prototype.emit=function(t){for(var s=[],i=1;i<arguments.length;i++)s.push(arguments[i]);var o="error"===t,n=this._events;if(void 0!==n)o=o&&void 0===n.error;else if(!o)return!1;if(o){var r;if(s.length>0&&(r=s[0]),r instanceof Error)throw r;var h=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw h.context=r,h}var c=n[t];if(void 0===c)return!1;if("function"==typeof c)e(c,this,s);else{var a=c.length,l=f(c,a);for(i=0;i<a;++i)e(l[i],this,s)}return!0},n.prototype.addListener=function(t,s){return a(this,t,s,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(t,s){return a(this,t,s,!0)},n.prototype.once=function(t,s){return h(s),this.on(t,u(this,t,s)),this},n.prototype.prependOnceListener=function(t,s){return h(s),this.prependListener(t,u(this,t,s)),this},n.prototype.removeListener=function(t,s){var i,e,o,n,r;if(h(s),void 0===(e=this._events))return this;if(void 0===(i=e[t]))return this;if(i===s||i.listener===s)0==--this._eventsCount?this._events=Object.create(null):(delete e[t],e.removeListener&&this.emit("removeListener",t,i.listener||s));else if("function"!=typeof i){for(o=-1,n=i.length-1;n>=0;n--)if(i[n]===s||i[n].listener===s){r=i[n].listener,o=n;break}if(o<0)return this;0===o?i.shift():function(t,s){for(;s+1<t.length;s++)t[s]=t[s+1];t.pop()}(i,o),1===i.length&&(e[t]=i[0]),void 0!==e.removeListener&&this.emit("removeListener",t,r||s)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(t){var s,i,e;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[t]),this;if(0===arguments.length){var o,n=Object.keys(i);for(e=0;e<n.length;++e)"removeListener"!==(o=n[e])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(s=i[t]))this.removeListener(t,s);else if(void 0!==s)for(e=s.length-1;e>=0;e--)this.removeListener(t,s[e]);return this},n.prototype.listeners=function(t){return p(this,t,!0)},n.prototype.rawListeners=function(t){return p(this,t,!1)},n.listenerCount=function(t,s){return"function"==typeof t.listenerCount?t.listenerCount(s):d.call(t,s)},n.prototype.listenerCount=d,n.prototype.eventNames=function(){return this._eventsCount>0?s(this._events):[]}},961:(t,s,i)=>{var e,o=function(){var t=String.fromCharCode,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={};function o(t,s){if(!e[t]){e[t]={};for(var i=0;i<t.length;i++)e[t][t.charAt(i)]=i}return e[t][s]}var n={compressToBase64:function(t){if(null==t)return"";var i=n._compress(t,6,(function(t){return s.charAt(t)}));switch(i.length%4){default:case 0:return i;case 1:return i+"===";case 2:return i+"==";case 3:return i+"="}},decompressFromBase64:function(t){return null==t?"":""==t?null:n._decompress(t.length,32,(function(i){return o(s,t.charAt(i))}))},compressToUTF16:function(s){return null==s?"":n._compress(s,15,(function(s){return t(s+32)}))+" "},decompressFromUTF16:function(t){return null==t?"":""==t?null:n._decompress(t.length,16384,(function(s){return t.charCodeAt(s)-32}))},compressToUint8Array:function(t){for(var s=n.compress(t),i=new Uint8Array(2*s.length),e=0,o=s.length;e<o;e++){var r=s.charCodeAt(e);i[2*e]=r>>>8,i[2*e+1]=r%256}return i},decompressFromUint8Array:function(s){if(null==s)return n.decompress(s);for(var i=new Array(s.length/2),e=0,o=i.length;e<o;e++)i[e]=256*s[2*e]+s[2*e+1];var r=[];return i.forEach((function(s){r.push(t(s))})),n.decompress(r.join(""))},compressToEncodedURIComponent:function(t){return null==t?"":n._compress(t,6,(function(t){return i.charAt(t)}))},decompressFromEncodedURIComponent:function(t){return null==t?"":""==t?null:(t=t.replace(/ /g,"+"),n._decompress(t.length,32,(function(s){return o(i,t.charAt(s))})))},compress:function(s){return n._compress(s,16,(function(s){return t(s)}))},_compress:function(t,s,i){if(null==t)return"";var e,o,n,r={},h={},c="",a="",l="",u=2,p=3,d=2,f=[],m=0,g=0;for(n=0;n<t.length;n+=1)if(c=t.charAt(n),Object.prototype.hasOwnProperty.call(r,c)||(r[c]=p++,h[c]=!0),a=l+c,Object.prototype.hasOwnProperty.call(r,a))l=a;else{if(Object.prototype.hasOwnProperty.call(h,l)){if(l.charCodeAt(0)<256){for(e=0;e<d;e++)m<<=1,g==s-1?(g=0,f.push(i(m)),m=0):g++;for(o=l.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o>>=1}else{for(o=1,e=0;e<d;e++)m=m<<1|o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o=0;for(o=l.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o>>=1}0==--u&&(u=Math.pow(2,d),d++),delete h[l]}else for(o=r[l],e=0;e<d;e++)m=m<<1|1&o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o>>=1;0==--u&&(u=Math.pow(2,d),d++),r[a]=p++,l=String(c)}if(""!==l){if(Object.prototype.hasOwnProperty.call(h,l)){if(l.charCodeAt(0)<256){for(e=0;e<d;e++)m<<=1,g==s-1?(g=0,f.push(i(m)),m=0):g++;for(o=l.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o>>=1}else{for(o=1,e=0;e<d;e++)m=m<<1|o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o=0;for(o=l.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o>>=1}0==--u&&(u=Math.pow(2,d),d++),delete h[l]}else for(o=r[l],e=0;e<d;e++)m=m<<1|1&o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o>>=1;0==--u&&(u=Math.pow(2,d),d++)}for(o=2,e=0;e<d;e++)m=m<<1|1&o,g==s-1?(g=0,f.push(i(m)),m=0):g++,o>>=1;for(;;){if(m<<=1,g==s-1){f.push(i(m));break}g++}return f.join("")},decompress:function(t){return null==t?"":""==t?null:n._decompress(t.length,32768,(function(s){return t.charCodeAt(s)}))},_decompress:function(s,i,e){var o,n,r,h,c,a,l,u=[],p=4,d=4,f=3,m="",g=[],y={val:e(0),position:i,index:1};for(o=0;o<3;o+=1)u[o]=o;for(r=0,c=Math.pow(2,2),a=1;a!=c;)h=y.val&y.position,y.position>>=1,0==y.position&&(y.position=i,y.val=e(y.index++)),r|=(h>0?1:0)*a,a<<=1;switch(r){case 0:for(r=0,c=Math.pow(2,8),a=1;a!=c;)h=y.val&y.position,y.position>>=1,0==y.position&&(y.position=i,y.val=e(y.index++)),r|=(h>0?1:0)*a,a<<=1;l=t(r);break;case 1:for(r=0,c=Math.pow(2,16),a=1;a!=c;)h=y.val&y.position,y.position>>=1,0==y.position&&(y.position=i,y.val=e(y.index++)),r|=(h>0?1:0)*a,a<<=1;l=t(r);break;case 2:return""}for(u[3]=l,n=l,g.push(l);;){if(y.index>s)return"";for(r=0,c=Math.pow(2,f),a=1;a!=c;)h=y.val&y.position,y.position>>=1,0==y.position&&(y.position=i,y.val=e(y.index++)),r|=(h>0?1:0)*a,a<<=1;switch(l=r){case 0:for(r=0,c=Math.pow(2,8),a=1;a!=c;)h=y.val&y.position,y.position>>=1,0==y.position&&(y.position=i,y.val=e(y.index++)),r|=(h>0?1:0)*a,a<<=1;u[d++]=t(r),l=d-1,p--;break;case 1:for(r=0,c=Math.pow(2,16),a=1;a!=c;)h=y.val&y.position,y.position>>=1,0==y.position&&(y.position=i,y.val=e(y.index++)),r|=(h>0?1:0)*a,a<<=1;u[d++]=t(r),l=d-1,p--;break;case 2:return g.join("")}if(0==p&&(p=Math.pow(2,f),f++),u[l])m=u[l];else{if(l!==d)return null;m=n+n.charAt(0)}g.push(m),u[d++]=n+m.charAt(0),n=m,0==--p&&(p=Math.pow(2,f),f++)}}};return n}();void 0===(e=function(){return o}.call(s,i,s,t))||(t.exports=e)}},s={};function i(e){if(s[e])return s[e].exports;var o=s[e]={exports:{}};return t[e](o,o.exports,i),o.exports}i.n=t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return i.d(s,{a:s}),s},i.d=(t,s)=>{for(var e in s)i.o(s,e)&&!i.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:s[e]})},i.o=(t,s)=>Object.prototype.hasOwnProperty.call(t,s),(()=>{"use strict";var t=i(961),s=i.n(t);const e=function(t,s,i,e=".",o=!1){this.name="unknown",this.x=s,this.y=i,this.passive=o,this.draw=o,this.glyph=o?e.toUpperCase():e,this.info="--",this.ports={},this.listen=function(s,i=!1){if(!s)return i?0:".";const e=t.glyphAt(this.x+s.x,this.y+s.y),o="."!==e&&"*"!==e||!s.default?e:s.default;if(i){const i=s.clamp&&s.clamp.min?s.clamp.min:0,e=s.clamp&&s.clamp.max?s.clamp.max:36;return function(t,s,i){return t<s?s:t>i?i:t}(t.valueOf(o),i,e)}return o},this.output=function(s,i=this.ports.output){i?s&&t.write(this.x+i.x,this.y+i.y,!0===this.shouldUpperCase()?(""+s).toUpperCase():s):console.warn(this.name,"Trying to output, but no port")},this.bang=function(s){this.ports.output?(t.write(this.x+this.ports.output.x,this.y+this.ports.output.y,s?"*":"."),t.lock(this.x+this.ports.output.x,this.y+this.ports.output.y)):console.warn(this.name,"Trying to bang, but no port")},this.run=function(s=!1){const i=this.operation(s);for(const s of Object.values(this.ports))s.bang||t.lock(this.x+s.x,this.y+s.y);this.ports.output&&(!0===this.ports.output.bang?this.bang(i):this.output(i))},this.operation=function(){},this.lock=function(){t.lock(this.x,this.y)},this.replace=function(s){t.write(this.x,this.y,s)},this.erase=function(){this.replace(".")},this.explode=function(){this.replace("*")},this.move=function(s,i){const e={x:this.x+s,y:this.y+i};if(!t.inBounds(e.x,e.y))return void this.explode();const o=t.glyphAt(e.x,e.y);"*"===o||"."===o?(this.erase(),this.x+=s,this.y+=i,this.replace(this.glyph),this.lock()):this.explode()},this.hasNeighbor=function(s){return t.glyphAt(this.x+1,this.y)===s||(t.glyphAt(this.x-1,this.y)===s||(t.glyphAt(this.x,this.y+1)===s||t.glyphAt(this.x,this.y-1)===s))},this.addPort=function(t,s){this.ports[t]=s},this.getPorts=function(){const t=[];if(!0===this.draw&&t.push([this.x,this.y,0,""+(this.name.charAt(0).toUpperCase()+this.name.substring(1).toLowerCase())]),!this.passive)return t;for(const s in this.ports){const i=this.ports[s],e=i.output?3:i.x<0||i.y<0?1:2;t.push([this.x+i.x,this.y+i.y,e,`${this.glyph}-${s}`])}return t},this.shouldUpperCase=function(t=this.ports){if(!this.ports.output||!this.ports.output.sensitive)return!1;const s=this.listen({x:1,y:0});return s.toLowerCase()!==s.toUpperCase()&&s.toUpperCase()===s}},o={a:function(t,s,i,o){e.call(this,t,s,i,"a",o),this.name="add",this.info="Outputs sum of inputs",this.ports.a={x:-1,y:0},this.ports.b={x:1,y:0},this.ports.output={x:0,y:1,sensitive:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.a,!0),e=this.listen(this.ports.b,!0);return t.keyOf(i+e)}},b:function(t,s,i,o){e.call(this,t,s,i,"b",o),this.name="subtract",this.info="Outputs difference of inputs",this.ports.a={x:-1,y:0},this.ports.b={x:1,y:0},this.ports.output={x:0,y:1,sensitive:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.a,!0),e=this.listen(this.ports.b,!0);return t.keyOf(Math.abs(e-i))}},c:function(t,s,i,o){e.call(this,t,s,i,"c",o),this.name="clock",this.info="Outputs modulo of frame",this.ports.rate={x:-1,y:0,clamp:{min:1}},this.ports.mod={x:1,y:0,default:"8"},this.ports.output={x:0,y:1,sensitive:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.rate,!0),e=this.listen(this.ports.mod,!0),o=Math.floor(t.f/i)%e;return t.keyOf(o)}},d:function(t,s,i,o){e.call(this,t,s,i,"d",o),this.name="delay",this.info="Bangs on modulo of frame",this.ports.rate={x:-1,y:0,clamp:{min:1}},this.ports.mod={x:1,y:0,default:"8"},this.ports.output={x:0,y:1,bang:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.rate,!0),e=this.listen(this.ports.mod,!0);return 0===t.f%(e*i)||1===e}},e:function(t,s,i,o){e.call(this,t,s,i,"e",o),this.name="east",this.info="Moves eastward, or bangs",this.draw=!1,this.operation=function(){this.move(1,0),this.passive=!1}},f:function(t,s,i,o){e.call(this,t,s,i,"f",o),this.name="if",this.info="Bangs if inputs are equal",this.ports.a={x:-1,y:0},this.ports.b={x:1,y:0},this.ports.output={x:0,y:1,bang:!0,output:!0},this.operation=function(t=!1){return this.listen(this.ports.a)===this.listen(this.ports.b)}},g:function(t,s,i,o){e.call(this,t,s,i,"g",o),this.name="generator",this.info="Writes operands with offset",this.ports.x={x:-3,y:0},this.ports.y={x:-2,y:0},this.ports.len={x:-1,y:0,clamp:{min:1}},this.operation=function(t=!1){const s=this.listen(this.ports.len,!0),i=this.listen(this.ports.x,!0),e=this.listen(this.ports.y,!0)+1;for(let t=0;t<s;t++){const s={x:t+1,y:0},o={x:i+t,y:e,output:!0};this.addPort("in"+t,s),this.addPort("out"+t,o);const n=this.listen(s);this.output(""+n,o)}}},h:function(t,s,i,o){e.call(this,t,s,i,"h",o),this.name="halt",this.info="Halts southward operand",this.ports.output={x:0,y:1,reader:!0,output:!0},this.operation=function(s=!1){return t.lock(this.x+this.ports.output.x,this.y+this.ports.output.y),this.listen(this.ports.output,!0)}},i:function(t,s,i,o){e.call(this,t,s,i,"i",o),this.name="increment",this.info="Increments southward operand",this.ports.step={x:-1,y:0,default:"1"},this.ports.mod={x:1,y:0},this.ports.output={x:0,y:1,sensitive:!0,reader:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.step,!0),e=this.listen(this.ports.mod,!0),o=this.listen(this.ports.output,!0);return t.keyOf((o+i)%(e>0?e:36))}},j:function(t,s,i,o){e.call(this,t,s,i,"j",o),this.name="jumper",this.info="Outputs northward operand",this.ports.val={x:0,y:-1},this.ports.output={x:0,y:1,output:!0},this.operation=function(s=!1){return t.lock(this.x,this.y+1),this.listen(this.ports.val)}},k:function(t,s,i,o){e.call(this,t,s,i,"k",o),this.name="konkat",this.info="Reads multiple variables",this.ports.len={x:-1,y:0,clamp:{min:1}},this.operation=function(s=!1){this.len=this.listen(this.ports.len,!0);for(let s=0;s<this.len;s++){const i=t.glyphAt(this.x+s+1,this.y);if(t.lock(this.x+s+1,this.y),"."===i)continue;const e={x:s+1,y:0},o={x:s+1,y:1,output:!0};this.addPort("in"+s,e),this.addPort("out"+s,o);const n=t.valueIn(i);this.output(""+n,o)}}},l:function(t,s,i,o){e.call(this,t,s,i,"l",o),this.name="lesser",this.info="Outputs smallest input",this.ports.a={x:-1,y:0},this.ports.b={x:1,y:0},this.ports.output={x:0,y:1,sensitive:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.a),e=this.listen(this.ports.b);return"."!==i&&"."!==e?t.keyOf(Math.min(t.valueOf(i),t.valueOf(e))):"."}},m:function(t,s,i,o){e.call(this,t,s,i,"m",o),this.name="multiply",this.info="Outputs product of inputs",this.ports.a={x:-1,y:0},this.ports.b={x:1,y:0},this.ports.output={x:0,y:1,sensitive:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.a,!0),e=this.listen(this.ports.b,!0);return t.keyOf(i*e)}},n:function(t,s,i,o){e.call(this,t,s,i,"n",o),this.name="north",this.info="Moves Northward, or bangs",this.draw=!1,this.operation=function(){this.move(0,-1),this.passive=!1}},o:function(t,s,i,o){e.call(this,t,s,i,"o",o),this.name="read",this.info="Reads operand with offset",this.ports.x={x:-2,y:0},this.ports.y={x:-1,y:0},this.ports.output={x:0,y:1,output:!0},this.operation=function(t=!1){const s=this.listen(this.ports.x,!0),i=this.listen(this.ports.y,!0);return this.addPort("read",{x:s+1,y:i}),this.listen(this.ports.read)}},p:function(t,s,i,o){e.call(this,t,s,i,"p",o),this.name="push",this.info="Writes eastward operand",this.ports.key={x:-2,y:0},this.ports.len={x:-1,y:0,clamp:{min:1}},this.ports.val={x:1,y:0},this.operation=function(s=!1){const i=this.listen(this.ports.len,!0),e=this.listen(this.ports.key,!0);for(let s=0;s<i;s++)t.lock(this.x+s,this.y+1);return this.ports.output={x:e%i,y:1,output:!0},this.listen(this.ports.val)}},q:function(t,s,i,o){e.call(this,t,s,i,"q",o),this.name="query",this.info="Reads operands with offset",this.ports.x={x:-3,y:0},this.ports.y={x:-2,y:0},this.ports.len={x:-1,y:0,clamp:{min:1}},this.operation=function(t=!1){const s=this.listen(this.ports.len,!0),i=this.listen(this.ports.x,!0),e=this.listen(this.ports.y,!0);for(let t=0;t<s;t++){const o={x:i+t+1,y:e},n={x:t-s+1,y:1,output:!0};this.addPort("in"+t,o),this.addPort("out"+t,n);const r=this.listen(o);this.output(""+r,n)}}},r:function(t,s,i,o){e.call(this,t,s,i,"r",o),this.name="random",this.info="Outputs random value",this.ports.min={x:-1,y:0},this.ports.max={x:1,y:0},this.ports.output={x:0,y:1,sensitive:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.min,!0),e=this.listen(this.ports.max,!0),o=parseInt(Math.random()*((e>0?e:36)-i)+i);return t.keyOf(o)}},s:function(t,s,i,o){e.call(this,t,s,i,"s",o),this.name="south",this.info="Moves southward, or bangs",this.draw=!1,this.operation=function(){this.move(0,1),this.passive=!1}},t:function(t,s,i,o){e.call(this,t,s,i,"t",o),this.name="track",this.info="Reads eastward operand",this.ports.key={x:-2,y:0},this.ports.len={x:-1,y:0,clamp:{min:1}},this.ports.output={x:0,y:1,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.len,!0),e=this.listen(this.ports.key,!0);for(let s=0;s<i;s++)t.lock(this.x+s+1,this.y);return this.ports.val={x:e%i+1,y:0},this.listen(this.ports.val)}},u:function(t,s,i,o){e.call(this,t,s,i,"u",o),this.name="uclid",this.info="Bangs on Euclidean rhythm",this.ports.step={x:-1,y:0,clamp:{min:0},default:"1"},this.ports.max={x:1,y:0,clamp:{min:1},default:"8"},this.ports.output={x:0,y:1,bang:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.step,!0),e=this.listen(this.ports.max,!0);return i*(t.f+e-1)%e+i>=e}},v:function(t,s,i,o){e.call(this,t,s,i,"v",o),this.name="variable",this.info="Reads and writes variable",this.ports.write={x:-1,y:0},this.ports.read={x:1,y:0},this.operation=function(s=!1){const i=this.listen(this.ports.write),e=this.listen(this.ports.read);if("."===i&&"."!==e&&this.addPort("output",{x:0,y:1}),"."===i)return t.valueIn(e);t.variables[i]=e}},w:function(t,s,i,o){e.call(this,t,s,i,"w",o),this.name="west",this.info="Moves westward, or bangs",this.draw=!1,this.operation=function(){this.move(-1,0),this.passive=!1}},x:function(t,s,i,o){e.call(this,t,s,i,"x",o),this.name="write",this.info="Writes operand with offset",this.ports.x={x:-2,y:0},this.ports.y={x:-1,y:0},this.ports.val={x:1,y:0},this.operation=function(t=!1){const s=this.listen(this.ports.x,!0),i=this.listen(this.ports.y,!0)+1;return this.addPort("output",{x:s,y:i,output:!0}),this.listen(this.ports.val)}},y:function(t,s,i,o){e.call(this,t,s,i,"y",o),this.name="jymper",this.info="Outputs westward operand",this.ports.val={x:-1,y:0},this.ports.output={x:1,y:0,output:!0},this.operation=function(s=!1){return t.lock(this.x+1,this.y),this.listen(this.ports.val)}},z:function(t,s,i,o){e.call(this,t,s,i,"z",o),this.name="lerp",this.info="Transitions operand to target",this.ports.rate={x:-1,y:0,default:"1"},this.ports.target={x:1,y:0},this.ports.output={x:0,y:1,sensitive:!0,reader:!0,output:!0},this.operation=function(s=!1){const i=this.listen(this.ports.rate,!0),e=this.listen(this.ports.target,!0),o=this.listen(this.ports.output,!0),n=o<=e-i?i:o>=e+i?-i:e-o;return t.keyOf(o+n)}},"*":function(t,s,i,o){e.call(this,t,s,i,"*",!0),this.name="bang",this.info="Bangs neighboring operands",this.draw=!1,this.run=function(t=!1){this.draw=!1,this.erase()}},"#":function(t,s,i,o){e.call(this,t,s,i,"#",!0),this.name="comment",this.info="Halts line",this.draw=!1,this.operation=function(){for(let s=this.x+1;s<=t.w&&(t.lock(s,this.y),t.glyphAt(s,this.y)!==this.glyph);s++);t.lock(this.x,this.y)}},$:function(t,s,i,o){e.call(this,t,s,i,"*",!0),this.name="self",this.info="Sends ORCA command",this.run=function(e=!1){let o="";for(let s=1;s<=36;s++){const i=t.glyphAt(this.x+s,this.y);if(t.lock(this.x+s,this.y),"."===i)break;o+=i}(this.hasNeighbor("*")||!1!==e)&&""!==o&&(this.draw=!1,client.commander.trigger(""+o,{x:s,y:i+1},!1))}},":":function(t,s,i,o){e.call(this,t,s,i,":",!0),this.name="midi",this.info="Sends MIDI note",this.ports.channel={x:1,y:0},this.ports.octave={x:2,y:0,clamp:{min:0,max:8}},this.ports.note={x:3,y:0},this.ports.velocity={x:4,y:0,default:"f",clamp:{min:0,max:16}},this.ports.length={x:5,y:0,default:"1",clamp:{min:0,max:32}},this.operation=function(t=!1){if(!this.hasNeighbor("*")&&!1===t)return;if("."===this.listen(this.ports.channel))return;if("."===this.listen(this.ports.octave))return;if("."===this.listen(this.ports.note))return;if(!isNaN(this.listen(this.ports.note)))return;const s=this.listen(this.ports.channel,!0);if(s>15)return;const i=this.listen(this.ports.octave,!0),e=this.listen(this.ports.note),o=this.listen(this.ports.velocity,!0),n=this.listen(this.ports.length,!0);client.io.midi.push(s,i,e,o,n),!0===t&&client.io.midi.run(),this.draw=!1}},"!":function(t,s,i){e.call(this,t,s,i,"!",!0),this.name="cc",this.info="Sends MIDI control change",this.ports.channel={x:1,y:0},this.ports.knob={x:2,y:0,clamp:{min:0}},this.ports.value={x:3,y:0,clamp:{min:0}},this.operation=function(t=!1){if(!this.hasNeighbor("*")&&!1===t)return;if("."===this.listen(this.ports.channel))return;if("."===this.listen(this.ports.knob))return;const s=this.listen(this.ports.channel,!0);if(s>15)return;const i=this.listen(this.ports.knob,!0),e=this.listen(this.ports.value,!0),o=Math.ceil(127*e/35);client.io.cc.stack.push({channel:s,knob:i,value:o,type:"cc"}),this.draw=!1,!0===t&&client.io.cc.run()}},"?":function(t,s,i){e.call(this,t,s,i,"?",!0),this.name="pb",this.info="Sends MIDI pitch bend",this.ports.channel={x:1,y:0,clamp:{min:0,max:15}},this.ports.lsb={x:2,y:0,clamp:{min:0}},this.ports.msb={x:3,y:0,clamp:{min:0}},this.operation=function(t=!1){if(!this.hasNeighbor("*")&&!1===t)return;if("."===this.listen(this.ports.channel))return;if("."===this.listen(this.ports.lsb))return;const s=this.listen(this.ports.channel,!0),i=this.listen(this.ports.lsb,!0),e=Math.ceil(127*i/35),o=this.listen(this.ports.msb,!0),n=Math.ceil(127*o/35);client.io.cc.stack.push({channel:s,lsb:e,msb:n,type:"pb"}),this.draw=!1,!0===t&&client.io.cc.run()}},"%":function(t,s,i,o){e.call(this,t,s,i,"%",!0),this.name="mono",this.info="Sends MIDI monophonic note",this.ports.channel={x:1,y:0},this.ports.octave={x:2,y:0,clamp:{min:0,max:8}},this.ports.note={x:3,y:0},this.ports.velocity={x:4,y:0,default:"f",clamp:{min:0,max:16}},this.ports.length={x:5,y:0,default:"1",clamp:{min:0,max:32}},this.operation=function(t=!1){if(!this.hasNeighbor("*")&&!1===t)return;if("."===this.listen(this.ports.channel))return;if("."===this.listen(this.ports.octave))return;if("."===this.listen(this.ports.note))return;if(!isNaN(this.listen(this.ports.note)))return;const s=this.listen(this.ports.channel,!0);if(s>15)return;const i=this.listen(this.ports.octave,!0),e=this.listen(this.ports.note),o=this.listen(this.ports.velocity,!0),n=this.listen(this.ports.length,!0);client.io.mono.push(s,i,e,o,n),!0===t&&client.io.mono.run(),this.draw=!1}},"=":function(t,s,i,o){e.call(this,t,s,i,"=",!0),this.name="osc",this.info="Sends OSC message",this.ports.path={x:1,y:0},this.operation=function(s=!1){let i="";for(let s=2;s<=36;s++){const e=t.glyphAt(this.x+s,this.y);if(t.lock(this.x+s,this.y),"."===e)break;i+=e}if(!this.hasNeighbor("*")&&!1===s)return;const e=this.listen(this.ports.path);e&&"."!==e&&(this.draw=!1,client.io.osc.push("/"+e,i),!0===s&&client.io.osc.run())}},";":function(t,s,i,o){e.call(this,t,s,i,";",!0),this.name="udp",this.info="Sends UDP message",this.operation=function(s=!1){let i="";for(let s=1;s<=36;s++){const e=t.glyphAt(this.x+s,this.y);if(t.lock(this.x+s,this.y),"."===e)break;i+=e}(this.hasNeighbor("*")||!1!==s)&&(this.draw=!1,client.io.udp.push(i),!0===s&&client.io.udp.run())}}};for(let t=0;t<=9;t++)o[""+t]=function(t,s,i,o){e.call(this,t,s,i,".",!1),this.name="null",this.info="empty",this.run=function(t=!1){}};const n=o;const r=function(t){this.all={},this.roles={},this.pipe=null,this.install=(t=window)=>{t.addEventListener("keydown",this.onKeyDown,!1),t.addEventListener("keyup",this.onKeyUp,!1)},this.set=(t,s,i,e,o)=>{this.all[i]&&console.warn("Acels",`Trying to overwrite ${this.all[i].name}, with ${s}.`),this.all[i]={cat:t,name:s,downfn:e,upfn:o,accelerator:i}},this.add=(t,s)=>{this.all[":"+s]={cat:t,name:s,role:s}},this.get=t=>this.all[t],this.sort=()=>{const t={};for(const s of Object.values(this.all))t[s.cat]||(t[s.cat]=[]),t[s.cat].push(s);return t},this.convert=t=>{const s=" "===t.key?"Space":t.key.substr(0,1).toUpperCase()+t.key.substr(1);return(t.ctrlKey||t.metaKey)&&t.shiftKey?"CmdOrCtrl+Shift+"+s:t.shiftKey&&t.key.toUpperCase()!==t.key?"Shift+"+s:t.altKey&&1!==t.key.length?"Alt+"+s:t.ctrlKey||t.metaKey?"CmdOrCtrl+"+s:s},this.pipe=t=>{this.pipe=t},this.onKeyDown=t=>{const s=this.get(this.convert(t));if(!s||!s.downfn)return this.pipe?this.pipe.onKeyDown(t):null;s.downfn(),t.preventDefault()},this.onKeyUp=t=>{const s=this.get(this.convert(t));if(!s||!s.upfn)return this.pipe?this.pipe.onKeyUp(t):null;s.upfn(),t.preventDefault()},this.toMarkdown=()=>{const t=this.sort();let s="";for(const i in t){s+=`\n### ${i}\n\n`;for(const e of t[i])s+=e.accelerator?`- \`${e.accelerator.replace("`","tilde")}\`: ${e.name}\n`:""}return s.trim()},this.toString=()=>{const t=this.sort();let s="";for(const i in t){s+=`\n${i}\n\n`;for(const e of t[i])s+=e.accelerator?`${e.name.padEnd(25,".")} ${e.accelerator}\n`:""}return s.trim()},this.inject=(s="Untitled")=>{const e=i(224).remote.app,o=[];o.push({label:s,submenu:[{label:"About",click:()=>{i(224).shell.openExternal("https://github.com/hundredrabbits/"+s)}},{label:"Theme",submenu:[{label:"Download Themes",click:()=>{i(224).shell.openExternal("https://github.com/hundredrabbits/Themes")}},{label:"Open Theme",click:()=>{t.theme.open()}},{label:"Reset Theme",accelerator:"CmdOrCtrl+Escape",click:()=>{t.theme.reset()}}]},{label:"Fullscreen",accelerator:"CmdOrCtrl+Enter",click:()=>{e.toggleFullscreen()}},{label:"Hide",accelerator:"CmdOrCtrl+H",click:()=>{e.toggleVisible()}},{label:"Toggle Menubar",accelerator:"Alt+H",click:()=>{e.toggleMenubar()}},{label:"Inspect",accelerator:"CmdOrCtrl+Tab",click:()=>{e.inspect()}},{role:"quit"}]});const n=this.sort();for(const t of Object.keys(n)){const s=[];for(const i of n[t])i.role?s.push({role:i.role}):i.type?s.push({type:i.type}):s.push({label:i.name,accelerator:i.accelerator,click:i.downfn});o.push({label:t,submenu:s})}e.injectMenu(o)}};const h=function(t){this.cache={},this.install=()=>{},this.start=()=>{this.new()},this.new=()=>{console.log("Source","New file.."),this.cache={}},this.open=(t,s,i=!1)=>{console.log("Source","Open file..");const e=document.createElement("input");e.type="file",e.onchange=e=>{const o=e.target.files[0];o.name.indexOf("."+t)<0?console.warn("Source","Skipped "+o.name):this.read(o,s,i)},e.click()},this.load=(t,s)=>{console.log("Source","Load files..");const i=document.createElement("input");i.type="file",i.setAttribute("multiple","multiple"),i.onchange=s=>{for(const i of s.target.files)i.name.indexOf("."+t)<0?console.warn("Source","Skipped "+i.name):this.read(i,this.store)},i.click()},this.store=(t,s)=>{console.info("Source","Stored "+t.name),this.cache[t.name]=s},this.save=(t,s,i="text/plain",e)=>{this.saveAs(t,s,i,e)},this.saveAs=(t,s,i,e="text/plain",o)=>{console.log("Source","Save new file.."),this.write(t,s,i,e,o)},this.read=(t,s,i=!1)=>{const e=new FileReader;e.onload=e=>{const o=e.target.result;s&&s(t,o),i&&this.store(t,o)},e.readAsText(t,"UTF-8")},this.write=(t,s,i,e,o="charset=utf-8")=>{const n=document.createElement("a");n.setAttribute("download",`${t}-${function(t=new Date,s=new Date(t)){return`${function(t=new Date){const s=new Date(t.getFullYear(),0,0),i=t-s+60*(s.getTimezoneOffset()-t.getTimezoneOffset())*1e3,e=Math.floor(i/864e5)-1,o=t.getFullYear().toString().substr(2,2),n=364===e||365===e?"+":String.fromCharCode(97+Math.floor(e/14)).toUpperCase(),r=(""+(1+(365===e?1:366===e?2:e%14))).padStart(2,"0");return`${o}${n}${r}`}()}-${function(t=new Date,s=new Date(t)){return((s-t.setHours(0,0,0,0))/8640/1e4).toFixed(6).substr(2,6)}()}`}()}.${s}`),"image/png"===e||"image/jpeg"===e?n.setAttribute("href",i):n.setAttribute("href","data:"+e+";"+o+","+encodeURIComponent(i)),n.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window}))}};const c=function(){function t(t,s,i){return t<s?s:t>i?i:t}this.index=0,this.frames=[],this.host=null,this.key=null,this.bind=function(t,s){console.log("History is recording.."),this.host=t,this.key=s,this.reset()},this.reset=function(){this.index=0,this.frames=[]},this.record=function(t){this.index===this.frames.length?this.append(t):this.fork(t),this.trim(),this.index=this.frames.length},this.undo=function(){0!==this.index?(this.index=t(this.index-1,0,this.frames.length-2),this.apply(this.frames[this.index])):console.warn("History","Reached beginning")},this.redo=function(){this.index+1>this.frames.length-1?console.warn("History","Reached end"):(this.index=t(this.index+1,0,this.frames.length-1),this.apply(this.frames[this.index]))},this.apply=function(t){this.host[this.key]?t&&t.length===this.host[this.key].length&&(this.host[this.key]=this.frames[this.index]):console.log("Unknown binding to key "+this.key)},this.append=function(t){t&&(this.frames[this.index-1]&&this.frames[this.index-1]===t||this.frames.push(t))},this.fork=function(t){this.frames=this.frames.slice(0,this.index+1),this.append(t)},this.trim=function(t=30){this.frames.length<t||this.frames.shift()},this.last=function(){return this.frames[this.index-1]},this.length=function(){return this.frames.length}};const a=function(t){this.keys="0123456789abcdefghijklmnopqrstuvwxyz".split(""),this.w=1,this.h=1,this.f=0,this.s="",this.locks=[],this.runtime=[],this.variables={},this.run=function(){this.runtime=this.parse(),this.operate(this.runtime),this.f+=1},this.reset=function(t=this.w,s=this.h){this.f=0,this.w=t,this.h=s,this.replace(new Array(this.h*this.w+1).join("."))},this.load=function(t,s,i,e=0){return this.w=t,this.h=s,this.f=e,this.replace(this.clean(i)),this},this.write=function(t,s,i){if(!i)return!1;if(1!==i.length)return!1;if(!this.inBounds(t,s))return!1;if(this.glyphAt(t,s)===i)return!1;const e=this.indexAt(t,s),o=this.isAllowed(i)?i:".",n=this.s.substr(0,e)+o+this.s.substr(e+1);return this.replace(n),!0},this.clean=t=>(""+t).replace(/\n/g,"").trim().substr(0,this.w*this.h).split("").map((t=>this.isAllowed(t)?t:".")).join(""),this.replace=function(t){this.s=t},this.parse=function(){const s=[];for(let i=0;i<this.h;i++)for(let e=0;e<this.w;e++){const o=this.glyphAt(e,i);"."!==o&&this.isAllowed(o)&&s.push(new(t[o.toLowerCase()])(this,e,i,o===o.toUpperCase()))}return s},this.operate=function(t){this.release();for(const s of t)this.lockAt(s.x,s.y)||(s.passive||s.hasNeighbor("*"))&&s.run()},this.bounds=function(){let t=0,s=0;for(let i=0;i<this.h;i++)for(let e=0;e<this.w;e++){"."!==this.glyphAt(e,i)&&(e>t&&(t=e),i>s&&(s=i))}return{w:t,h:s}},this.getBlock=(t,s,i,e)=>{let o="";for(let n=s;n<s+e;n++){let s="";for(let e=t;e<t+i;e++)s+=this.glyphAt(e,n);o+=s+"\n"}return o},this.writeBlock=(t,s,i,e=!1)=>{if(!i)return;const o=i.split(/\r?\n/);let n=s;for(const s of o){let i=t;for(const t in s){const o=s[t];this.write(i,n,!0===e&&"."===o?this.glyphAt(i,n):o),i++}n++}},this.release=function(){this.locks=new Array(this.w*this.h),this.variables={}},this.unlock=function(t,s){this.locks[this.indexAt(t,s)]=null},this.lock=function(t,s){this.lockAt(t,s)||(this.locks[this.indexAt(t,s)]=!0)},this.inBounds=function(t,s){return Number.isInteger(t)&&Number.isInteger(s)&&t>=0&&t<this.w&&s>=0&&s<this.h},this.isAllowed=function(s){return"."===s||!!t[(""+s).toLowerCase()]},this.isSpecial=function(t){return t.toLowerCase()===t.toUpperCase()&&isNaN(t)},this.keyOf=function(t,s=!1){return!0===s?this.keys[t%36].toUpperCase():this.keys[t%36]},this.valueOf=function(t){return t&&"."!==t&&"*"!==t?this.keys.indexOf((""+t).toLowerCase()):0},this.indexAt=function(t,s){return!0===this.inBounds(t,s)?t+this.w*s:-1},this.operatorAt=function(t,s){return this.runtime.filter((i=>i.x===t&&i.y===s))[0]},this.posAt=function(t){return{x:t%this.w,y:parseInt(t/this.w)}},this.glyphAt=function(t,s){return this.s.charAt(this.indexAt(t,s))},this.valueAt=function(t,s){return this.valueOf(this.glyphAt(t,s))},this.lockAt=function(t,s){return!0===this.locks[this.indexAt(t,s)]},this.valueIn=function(t){return this.variables[t]||"."},this.format=()=>{const t=[];for(let s=0;s<this.h;s++)t.push(this.s.substr(s*this.w,this.w));return t.reduce(((t,s)=>`${t}${s}\n`),"")},this.length=()=>this.strip().length,this.strip=()=>this.s.replace(/[^a-zA-Z0-9+]+/gi,"").trim(),this.toString=()=>this.format().trim(),this.toRect=(t=this.s)=>{const s=t.trim().split(/\r?\n/);return{x:s[0].length,y:s.length}},this.reset()},l={A:"A0",a:"a0",B:"B0",C:"C0",c:"c0",D:"D0",d:"d0",E:"E0",F:"F0",f:"f0",G:"G0",g:"g0",H:"A0",h:"a0",I:"B0",J:"C1",j:"c1",K:"D1",k:"d1",L:"E1",M:"F1",m:"f1",N:"G1",n:"g1",O:"A1",o:"a1",P:"B1",Q:"C2",q:"c2",R:"D2",r:"d2",S:"E2",T:"F2",t:"f2",U:"G2",u:"g2",V:"A2",v:"a2",W:"B2",X:"C3",x:"c3",Y:"D3",y:"d3",Z:"E3",e:"F0",l:"F1",s:"F2",z:"F3",b:"C1",i:"C1",p:"C2",w:"C3"};const u=function(t){function s(t,s,i){return t<s?s:t>i?i:t}this.mode=0,this.isClock=!1,this.outputIndex=-1,this.inputIndex=-1,this.outputs=[],this.inputs=[],this.stack=[],this.start=function(){console.info("Midi Starting.."),this.refresh()},this.clear=function(){this.stack=this.stack.filter((t=>t))},this.run=function(){for(const t in this.stack){const s=this.stack[t];!1===s.isPlayed&&this.press(s),s.length<1?this.release(s,t):s.length--}},this.trigger=function(s,i){if(!this.outputDevice())return void console.warn("MIDI","No midi output!");const e=this.transpose(s.note,s.octave),o=isNaN(s.channel)?t.orca.valueOf(s.channel):parseInt(s.channel);if(!e)return;const n=!0===i?144+o:128+o,r=e.id,h=parseInt(s.velocity/16*127);r&&127!==n&&this.outputDevice().send([n,r,h])},this.press=function(t){t&&(this.trigger(t,!0),t.isPlayed=!0)},this.release=function(t,s){t&&(this.trigger(t,!1),delete this.stack[s])},this.silence=function(){for(const t of this.stack)this.release(t)},this.push=function(t,s,i,e,o,n=!1){const r={channel:t,octave:s,note:i,velocity:e,length:o,isPlayed:n};for(const e in this.stack){const o=this.stack[e];o.channel===t&&o.octave===s&&o.note===i&&this.release(r,e)}this.stack.push(r)},this.allNotesOff=function(){if(this.outputDevice()){console.log("MIDI","All Notes Off");for(let t=0;t<16;t++)this.outputDevice().send([176+t,123,0])}},this.ticks=[],this.sendClockStart=function(){this.outputDevice()&&(this.isClock=!0,this.outputDevice().send([250],0),console.log("MIDI","MIDI Start Sent"))},this.sendClockStop=function(){this.outputDevice()&&(this.isClock=!1,this.outputDevice().send([252],0),console.log("MIDI","MIDI Stop Sent"))},this.sendClock=function(){if(!this.outputDevice())return;if(!0!==this.isClock)return;const s=6e4/t.clock.speed.value/4/6;for(let t=0;t<6;t++)this.ticks[t]&&clearTimeout(this.ticks[t]),this.ticks[t]=setTimeout((()=>{this.outputDevice().send([248],0)}),parseInt(t)*s)},this.receive=function(s){switch(s.data[0]){case 248:t.clock.tap();break;case 250:console.log("MIDI","Start Received"),t.clock.play(!1,!0);break;case 251:console.log("MIDI","Continue Received"),t.clock.play();break;case 252:console.log("MIDI","Stop Received"),t.clock.stop()}},this.selectOutput=function(t){if(-1===t)return this.outputIndex=-1,void console.log("MIDI","Select Output Device: None");this.outputs[t]?(this.outputIndex=parseInt(t),console.log("MIDI","Select Output Device: "+this.outputDevice().name)):console.warn("MIDI","Unknown device with id "+t)},this.selectInput=function(t){if(this.inputDevice()&&(this.inputDevice().onmidimessage=null),-1===t)return this.inputIndex=-1,void console.log("MIDI","Select Input Device: None");this.inputs[t]?(this.inputIndex=parseInt(t),this.inputDevice().onmidimessage=t=>{this.receive(t)},console.log("MIDI","Select Input Device: "+this.inputDevice().name)):console.warn("MIDI","Unknown device with id "+t)},this.outputDevice=function(){return this.outputs[this.outputIndex]},this.inputDevice=function(){return this.inputs[this.inputIndex]},this.selectNextOutput=()=>{this.outputIndex=this.outputIndex<this.outputs.length?this.outputIndex+1:0,t.update()},this.selectNextInput=()=>{const s=this.inputIndex<this.inputs.length-1?this.inputIndex+1:-1;this.selectInput(s),t.update()},this.refresh=function(){navigator.requestMIDIAccess&&navigator.requestMIDIAccess().then(this.access,(t=>{console.warn("No Midi",t)}))},this.access=t=>{const s=t.outputs.values();this.outputs=[];for(let t=s.next();t&&!t.done;t=s.next())this.outputs.push(t.value);this.selectOutput(0);const i=t.inputs.values();this.inputs=[];for(let t=i.next();t&&!t.done;t=i.next())this.inputs.push(t.value);this.selectInput(-1)},this.transpose=function(t,i=3){if(!l[t])return null;const e=s(parseInt(i)+parseInt(l[t].charAt(1)),0,8),o=l[t].charAt(0),n=["C","c","D","d","E","F","f","G","g","A","a","B"].indexOf(o);return{id:s(12*e+n+24,0,127),value:n,note:o,octave:e}},this.convert=function(t){const s=`${["C","c","D","d","E","F","f","G","g","A","a","B"][t%12]}${Math.floor(t/12)-5}`,i=Object.values(l).indexOf(s);return Object.keys(l)[i]},this.toString=function(){return navigator.requestMIDIAccess?this.outputDevice()?""+this.outputDevice().name:"No Midi Device":"No Midi Support"},this.toInputString=()=>navigator.requestMIDIAccess?this.inputDevice()?""+this.inputDevice().name:"No Input Device":"No Midi Support",this.toOutputString=()=>navigator.requestMIDIAccess?this.outputDevice()?""+this.outputDevice().name:"No Output Device":"No Midi Support",this.length=function(){return this.stack.length}};const p=function(t){this.stack=[],this.offset=64,this.start=function(){console.info("MidiCC","Starting..")},this.clear=function(){this.stack=[]},this.run=function(){if(this.stack.length<1)return;const s=t.io.midi.outputDevice();if(s)for(const t of this.stack)"cc"!==t.type||isNaN(t.channel)||isNaN(t.knob)||isNaN(t.value)?"pb"!==t.type||isNaN(t.channel)||isNaN(t.lsb)||isNaN(t.msb)?"pg"!==t.type||isNaN(t.channel)?console.warn("CC","Unknown message",t):(isNaN(t.bank)||s.send([176+t.channel,0,t.bank]),isNaN(t.sub)||s.send([176+t.channel,32,t.sub]),isNaN(t.pgm)||s.send([192+t.channel,t.pgm])):s.send([224+t.channel,t.lsb,t.msb]):s.send([176+t.channel,this.offset+t.knob,t.value]);else console.warn("CC","No Midi device.")},this.setOffset=function(t){isNaN(t)||(this.offset=t,console.log("CC","Set offset to "+this.offset))}};const d=function(t){this.stack={},this.start=function(){console.info("MidiMono Starting..")},this.clear=function(){},this.run=function(){for(const t in this.stack)this.stack[t].length<1&&this.release(this.stack[t],t),this.stack[t]&&(!1===this.stack[t].isPlayed&&this.press(this.stack[t]),this.stack[t].length--)},this.press=function(s){s&&(t.io.midi.trigger(s,!0),s.isPlayed=!0)},this.release=function(s){s&&(t.io.midi.trigger(s,!1),delete this.stack[s.channel])},this.silence=function(){for(const t of this.stack)this.release(t)},this.push=function(t,s,i,e,o,n=!1){this.stack[t]&&this.release(this.stack[t]),this.stack[t]={channel:t,octave:s,note:i,velocity:e,length:o,isPlayed:n}},this.length=function(){return Object.keys(this.stack).length}};var f=i(786);const m=function(t){const s=i(724);this.stack=[],this.port=null,this.socket=s?s.createSocket("udp4"):null,this.listener=s?s.createSocket("udp4"):null,this.start=function(){s&&this.socket&&this.listener?(console.info("UDP","Starting.."),this.selectInput(),this.selectOutput()):console.warn("UDP","Could not start.")},this.clear=function(){this.stack=[]},this.run=function(){for(const t of this.stack)this.play(t)},this.push=function(t){this.stack.push(t)},this.play=function(s){this.socket&&this.socket.send(f.from(""+s),this.port,t.io.ip,(t=>{t&&console.warn(t)}))},this.selectOutput=function(t=49161){s?parseInt(t)!==this.port?isNaN(t)||t<1e3?console.warn("UDP","Unavailable port"):(console.log("UDP","Output: "+t),this.port=parseInt(t)):console.warn("UDP","Already selected"):console.warn("UDP","Unavailable.")},this.selectInput=(i=49160)=>{s?(this.listener&&this.listener.close(),console.log("UDP","Input: "+i),this.listener=s.createSocket("udp4"),this.listener.on("message",((s,i)=>{t.commander.trigger(""+s)})),this.listener.on("listening",(()=>{const t=this.listener.address();console.info("UDP",`Started socket at ${t.address}:${t.port}`)})),this.listener.on("error",(t=>{console.warn("UDP","Server error:\n "+t.stack),this.listener.close()})),this.listener.bind(i)):console.warn("UDP","Unavailable.")}};const g=function(t){const s=i(500);this.stack=[],this.socket=null,this.port=null,this.options={default:49162,tidalCycles:6010,sonicPi:4559,superCollider:57120,norns:10111},this.start=function(){s?(console.info("OSC","Starting.."),this.setup(),this.select()):console.warn("OSC","Could not start.")},this.clear=function(){this.stack=[]},this.run=function(){for(const t of this.stack)this.play(t)},this.push=function(t,s){this.stack.push({path:t,msg:s})},this.play=function({path:i,msg:e}){if(!this.socket)return void console.warn("OSC","Unavailable socket");const o=new s.Message(i);for(var n=0;n<e.length;n++)o.append(t.orca.valueOf(e.charAt(n)));this.socket.send(o,(t=>{t&&console.warn(t)}))},this.select=function(t=this.options.default){parseInt(t)!==this.port?isNaN(t)||t<1e3?console.warn("OSC","Unavailable port"):(console.info("OSC","Selected port: "+t),this.port=parseInt(t),this.setup()):console.warn("OSC","Already selected")},this.setup=function(){this.port&&(this.socket&&this.socket.close(),this.socket=new s.Client(t.io.ip,this.port),console.info("OSC",`Started socket at ${t.io.ip}:${this.port}`))}};const y=function(t){this.ip="127.0.0.1",this.midi=new u(t),this.cc=new p(t),this.mono=new d(t),this.udp=new m(t),this.osc=new g(t),this.start=function(){this.midi.start(),this.cc.start(),this.mono.start(),this.udp.start(),this.osc.start(),this.clear()},this.clear=function(){this.midi.clear(),this.cc.clear(),this.mono.clear(),this.udp.clear(),this.osc.clear()},this.run=function(){this.midi.run(),this.cc.run(),this.mono.run(),this.udp.run(),this.osc.run()},this.silence=function(){this.midi.silence(),this.mono.silence()},this.setIp=function(t="127.0.0.1"){!0===function(t){return!!/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(t)}(t)||-1!==t.indexOf(".local")?(this.ip=t,console.log("IO","Set target IP to "+this.ip),this.osc.setup()):console.warn("IO","Invalid IP")},this.length=function(){return this.midi.length()+this.mono.length()+this.cc.stack.length+this.udp.stack.length+this.osc.stack.length},this.inspect=function(s=t.grid.w){let i="";for(let t=0;t<this.length();t++)i+="|";return function(t,s,i){for(;t.length<s;)t+=i;return t}(i,s,".")}};const w=function(t){function s(t,s,i){return t<s?s:t>i?i:t}this.x=0,this.y=0,this.w=0,this.h=0,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.ins=!1,this.start=()=>{document.onmousedown=this.onMouseDown,document.onmouseup=this.onMouseUp,document.onmousemove=this.onMouseMove,document.oncopy=this.onCopy,document.oncut=this.onCut,document.onpaste=this.onPaste,document.oncontextmenu=this.onContextMenu},this.select=(i=this.x,e=this.y,o=this.w,n=this.h)=>{if(isNaN(i)||isNaN(e)||isNaN(o)||isNaN(n))return;const r={x:s(parseInt(i),0,t.orca.w-1),y:s(parseInt(e),0,t.orca.h-1),w:s(parseInt(o),-this.x,t.orca.w-1),h:s(parseInt(n),-this.y,t.orca.h-1)};this.x===r.x&&this.y===r.y&&this.w===r.w&&this.h===r.h||(this.x=r.x,this.y=r.y,this.w=r.w,this.h=r.h,this.calculateBounds(),t.toggleGuide(!1),t.update())},this.selectAll=()=>{this.select(0,0,t.orca.w,t.orca.h),this.ins=!1},this.move=(t,s)=>{this.select(this.x+parseInt(t),this.y-parseInt(s))},this.moveTo=(t,s)=>{this.select(t,s)},this.scale=(t,s)=>{this.select(this.x,this.y,this.w+parseInt(t),this.h-parseInt(s))},this.scaleTo=(t,s)=>{this.select(this.x,this.y,t,s)},this.drag=(s,i)=>{if(isNaN(s)||isNaN(i))return;this.ins=!1;const e=this.selection();this.erase(),this.move(s,i),t.orca.writeBlock(this.minX,this.minY,e),t.history.record(t.orca.s)},this.reset=(t=!1)=>{this.select(t?0:this.x,t?0:this.y,0,0),this.ins=0},this.read=()=>t.orca.glyphAt(this.x,this.y),this.write=s=>{t.orca.isAllowed(s)&&(t.orca.write(this.x,this.y,s)&&this.ins&&this.move(1,0),t.history.record(t.orca.s))},this.erase=()=>{for(let s=this.minY;s<=this.maxY;s++)for(let i=this.minX;i<=this.maxX;i++)t.orca.write(i,s,".");t.history.record(t.orca.s)},this.find=s=>{const i=t.orca.s.indexOf(s);if(i<0)return;const e=t.orca.posAt(i);this.select(e.x,e.y,s.length-1,0)},this.inspect=()=>{if(0!==this.w||0!==this.h)return"multi";const s=t.orca.indexAt(this.x,this.y),i=t.ports[s];return i?""+i[3]:t.orca.lockAt(this.x,this.y)?"locked":"empty"},this.trigger=()=>{const s=t.orca.operatorAt(this.x,this.y);s?(console.log("Cursor","Trigger: "+s.name),s.run(!0)):console.warn("Cursor","Nothing to trigger.")},this.comment=()=>{const s=this.selection(),i=s.trim().split(/\r?\n/),e="#"===s.substr(0,1)?".":"#",o=i.map((t=>`${e}${t.substr(1,t.length-2)}${e}`)).join("\n");t.orca.writeBlock(this.minX,this.minY,o),t.history.record(t.orca.s)},this.toUpperCase=()=>{const s=this.selection().toUpperCase();t.orca.writeBlock(this.minX,this.minY,s)},this.toLowerCase=()=>{const s=this.selection().toLowerCase();t.orca.writeBlock(this.minX,this.minY,s)},this.toRect=()=>({x:this.minX,y:this.minY,w:this.maxX-this.minX+1,h:this.maxY-this.minY+1}),this.calculateBounds=()=>{this.minX=this.x<this.x+this.w?this.x:this.x+this.w,this.minY=this.y<this.y+this.h?this.y:this.y+this.h,this.maxX=this.x>this.x+this.w?this.x:this.x+this.w,this.maxY=this.y>this.y+this.h?this.y:this.y+this.h},this.selected=(t,s,i=0,e=0)=>t>=this.minX&&t<=this.maxX&&s>=this.minY&&s<=this.maxY,this.selection=(s=this.toRect())=>t.orca.getBlock(s.x,s.y,s.w,s.h),this.mouseFrom=null,this.onMouseDown=t=>{if(0!==t.button)return void this.cut();const s=this.mousePick(t.clientX,t.clientY);this.select(s.x,s.y,0,0),this.mouseFrom=s},this.onMouseMove=t=>{if(!this.mouseFrom)return;const s=this.mousePick(t.clientX,t.clientY);this.select(this.mouseFrom.x,this.mouseFrom.y,s.x-this.mouseFrom.x,s.y-this.mouseFrom.y)},this.onMouseUp=t=>{if(this.mouseFrom){const s=this.mousePick(t.clientX,t.clientY);this.select(this.mouseFrom.x,this.mouseFrom.y,s.x-this.mouseFrom.x,s.y-this.mouseFrom.y)}this.mouseFrom=null},this.mousePick=(s,i,e=t.tile.w,o=t.tile.h)=>({x:parseInt((s-30)/e),y:parseInt((i-30)/o)}),this.onContextMenu=t=>{t.preventDefault()},this.copy=function(){document.execCommand("copy")},this.cut=function(){document.execCommand("cut")},this.paste=function(t=!1){document.execCommand("paste")},this.onCopy=t=>{t.clipboardData.setData("text/plain",this.selection()),t.preventDefault()},this.onCut=t=>{this.onCopy(t),this.erase()},this.onPaste=s=>{const i=s.clipboardData.getData("text/plain").trim();t.orca.writeBlock(this.minX,this.minY,i,this.ins),t.history.record(t.orca.s),this.scaleTo(i.split(/\r?\n/)[0].length-1,i.split(/\r?\n/).length-1),s.preventDefault()}};const v=function(t){this.isActive=!1,this.query="",this.history=[],this.historyIndex=0,this.passives={find:s=>{t.cursor.find(s.str)},select:s=>{t.cursor.select(s.x,s.y,s.w||0,s.h||0)},inject:s=>{if(t.cursor.select(s._x,s._y),t.source.cache[s._str+".orca"]){const i=t.source.cache[s._str+".orca"],e=t.orca.toRect(i);t.cursor.scaleTo(e.x,e.y)}}},this.actives={osc:s=>{t.io.osc.select(s.int)},udp:s=>{t.io.udp.selectOutput(s.x),null!==s.y&&t.io.udp.selectInput(s.y)},midi:s=>{t.io.midi.selectOutput(s.x),null!==s.y&&t.io.midi.selectInput(s.y)},ip:s=>{t.io.setIp(s.str)},cc:s=>{t.io.cc.setOffset(s.int)},pg:s=>{t.io.cc.stack.push({channel:i(s.ints[0],0,15),bank:s.ints[1],sub:s.ints[2],pgm:i(s.ints[3],0,127),type:"pg"}),t.io.cc.run()},copy:s=>{t.cursor.copy()},paste:s=>{t.cursor.paste(!0)},erase:s=>{t.cursor.erase()},play:s=>{t.clock.play()},stop:s=>{t.clock.stop()},run:s=>{t.run()},apm:s=>{t.clock.setSpeed(null,s.int)},bpm:s=>{t.clock.setSpeed(s.int,s.int,!0)},frame:s=>{t.clock.setFrame(s.int)},rewind:s=>{t.clock.setFrame(t.orca.f-s.int)},skip:s=>{t.clock.setFrame(t.orca.f+s.int)},time:(s,i)=>{const e=new Date(t.orca.f*(60/t.clock.speed.value)*250).toISOString().substr(14,5).replace(/:/g,"");t.orca.writeBlock(i?i.x:t.cursor.x,i?i.y:t.cursor.y,""+e)},color:s=>{s.parts[0]&&t.theme.set("b_low",s.parts[0]),s.parts[1]&&t.theme.set("b_med",s.parts[1]),s.parts[2]&&t.theme.set("b_high",s.parts[2])},find:s=>{t.cursor.find(s.str)},select:s=>{t.cursor.select(s.x,s.y,s.w||0,s.h||0)},inject:(s,i)=>{const e=t.source.cache[s._str+".orca"];e?(t.orca.writeBlock(i?i.x:t.cursor.x,i?i.y:t.cursor.y,e),t.cursor.scaleTo(0,0)):console.warn("Commander","Unknown block: "+s._str)},write:s=>{t.orca.writeBlock(s._x||t.cursor.x,s._y||t.cursor.y,s._str)}};for(const t in this.actives)this.actives[t.substr(0,2)]=this.actives[t];function s(t){this.str=""+t,this.length=this.str.length,this.chars=this.str.split(""),this.int=isNaN(t)?null:parseInt(t),this.parts=t.split(";"),this.ints=this.parts.map((t=>parseInt(t))),this.x=parseInt(this.parts[0]),this.y=parseInt(this.parts[1]),this.w=parseInt(this.parts[2]),this.h=parseInt(this.parts[3]),this._str=this.parts[0],this._x=parseInt(this.parts[1]),this._y=parseInt(this.parts[2])}function i(t,s,i){return t<s?s:t>i?i:t}this.start=(s="")=>{this.isActive=!0,this.query=s,t.cursor.ins=!1,t.update()},this.stop=()=>{this.isActive=!1,this.query="",this.historyIndex=this.history.length,t.update()},this.erase=function(){this.query=this.query.slice(0,-1),this.preview()},this.write=t=>{"Backspace"!==t?"Enter"!==t?"Escape"!==t?t.length>1||(this.query+=t,this.preview()):this.stop():this.run():this.erase()},this.run=function(){const s=!0===this.isActive?"commander":"cursor";t[s].trigger(),t.update()},this.trigger=function(t=this.query,i=null,e=!0){const o=(""+t).split(":")[0].trim().replace(/\W/g,"").toLowerCase(),n=(""+t).substr(o.length+1),r=this.actives[o];if(!r)return console.warn("Commander","Unknown message: "+t),void this.stop();r(new s(n),i),this.history.push(t),this.historyIndex=this.history.length,e&&this.stop()},this.preview=function(t=this.query){const i=(""+t).split(":")[0].toLowerCase(),e=(""+t).substr(i.length+1);this.passives[i]&&this.passives[i](new s(e),!1)},this.onKeyDown=s=>{s.ctrlKey||s.metaKey||(t[!0===this.isActive?"commander":"cursor"].write(s.key),s.stopPropagation())},this.onKeyUp=s=>{t.update()},this.toString=function(){return""+this.query}};const x=function(t){const s=window.URL.createObjectURL(new Blob(["onmessage = (e) => { setInterval(() => { postMessage(true) }, e.data)}"],{type:"text/javascript"}));this.isPaused=!0,this.timer=null,this.isPuppet=!1,this.speed={value:120,target:120},this.start=function(){const t=parseInt(window.localStorage.getItem("bpm")),s=t>=60?t:120;this.setSpeed(s,s,!0),this.play()},this.touch=function(){this.stop(),t.run()},this.run=function(){this.speed.target!==this.speed.value&&this.setSpeed(this.speed.value+(this.speed.value<this.speed.target?1:-1),null,!0)},this.setSpeed=(t,s=null,i=!1)=>{this.speed.value===t&&this.speed.target===s&&this.timer||(t&&(this.speed.value=e(t,60,300)),s&&(this.speed.target=e(s,60,300)),!0===i&&this.setTimer(this.speed.value))},this.modSpeed=function(s=0,i=!1){!0===i?this.setSpeed(null,this.speed.target+s):(this.setSpeed(this.speed.value+s,this.speed.value+s,!0),t.update())},this.togglePlay=function(s=!1){!0===this.isPaused?this.play(s):this.stop(s),t.update()},this.play=function(s=!1,e=!1){console.log("Clock","Play",s,e),(!1!==this.isPaused||e)&&(this.isPaused=!1,!0===this.isPuppet?(console.warn("Clock","External Midi control"),i.frame&&!e||(this.setFrame(0),i.frame=0,i.count=5)):(!0===s&&t.io.midi.sendClockStart(),this.setSpeed(this.speed.target,this.speed.target,!0)))},this.stop=function(s=!1){console.log("Clock","Stop"),!0!==this.isPaused&&(this.isPaused=!0,!0===this.isPuppet?console.warn("Clock","External Midi control"):((!0===s||t.io.midi.isClock)&&t.io.midi.sendClockStop(),this.clearTimer()),t.io.midi.allNotesOff(),t.io.midi.silence())};const i={count:0,last:null,timer:null,frame:0};function e(t,s,i){return t<s?s:t>i?i:t}this.tap=function(){i.count=(i.count+1)%6,i.last=performance.now(),this.isPuppet||(console.log("Clock","Puppeteering starts.."),this.isPuppet=!0,this.clearTimer(),i.timer=setInterval((()=>{performance.now()-i.last<2e3||this.untap()}),2e3)),0==i.count&&(this.isPaused?i.frame++:(i.frame>0&&(this.setFrame(t.orca.f+i.frame),i.frame=0),t.run()))},this.untap=function(){console.log("Clock","Puppeteering stops.."),clearInterval(i.timer),this.isPuppet=!1,i.frame=0,i.last=null,this.isPaused||this.setTimer(this.speed.value)},this.setTimer=function(i){i<60?console.warn("Clock","Error "+i):(this.clearTimer(),window.localStorage.setItem("bpm",i),this.timer=new Worker(s),this.timer.postMessage(6e4/parseInt(i)/4),this.timer.onmessage=s=>{t.io.midi.sendClock(),t.run()})},this.clearTimer=function(){this.timer&&this.timer.terminate(),this.timer=null},this.setFrame=function(s){isNaN(s)||(t.orca.f=e(s,0,9999999))},this.toString=function(){const s=this.speed.target-this.speed.value,i=Math.abs(s)>5?s>0?"+"+s:s:"";return`${!0===this.isPuppet?"midi":`${this.speed.value}${i}`}${0===s&&t.orca.f%4==0?"*":""}`}};const b=function(t){function s(t){return!!t&&(!(!t.background||!i(t.background))&&(!(!t.f_high||!i(t.f_high))&&(!(!t.f_med||!i(t.f_med))&&(!(!t.f_low||!i(t.f_low))&&(!(!t.f_inv||!i(t.f_inv))&&(!(!t.b_high||!i(t.b_high))&&(!(!t.b_med||!i(t.b_med))&&(!(!t.b_low||!i(t.b_low))&&!(!t.b_inv||!i(t.b_inv))))))))))}function i(t){return/^#([0-9A-F]{3}){1,2}$/i.test(t)}function e(t){try{return JSON.parse(t),!0}catch(t){return!1}}this.el=document.createElement("style"),this.el.type="text/css",this.active={},this.default={background:"#eeeeee",f_high:"#0a0a0a",f_med:"#4a4a4a",f_low:"#6a6a6a",f_inv:"#111111",b_high:"#a1a1a1",b_med:"#c1c1c1",b_low:"#ffffff",b_inv:"#ffb545"},this.onLoad=()=>{},this.install=(t=document.body)=>{window.addEventListener("dragover",this.drag),window.addEventListener("drop",this.drop),t.appendChild(this.el)},this.start=()=>{if(console.log("Theme","Starting.."),e(localStorage.theme)){const t=JSON.parse(localStorage.theme);if(s(t))return console.log("Theme","Loading theme in localStorage.."),void this.load(t)}this.load(this.default)},this.open=()=>{console.log("Theme","Open theme..");const t=document.createElement("input");t.type="file",t.onchange=t=>{this.read(t.target.files[0],this.load)},t.click()},this.load=t=>{const i=this.parse(t);s(i)?(console.log("Theme","Loaded theme!"),this.el.innerHTML=`:root { \n      --background: ${i.background}; \n      --f_high: ${i.f_high}; \n      --f_med: ${i.f_med}; \n      --f_low: ${i.f_low}; \n      --f_inv: ${i.f_inv}; \n      --b_high: ${i.b_high}; \n      --b_med: ${i.b_med}; \n      --b_low: ${i.b_low}; \n      --b_inv: ${i.b_inv};\n    }`,localStorage.setItem("theme",JSON.stringify(i)),this.active=i,this.onLoad&&this.onLoad(t)):console.warn("Theme","Invalid format")},this.reset=()=>{this.load(this.default)},this.set=(t,s)=>{if(!s)return;const e=("#"!==(""+s).substr(0,1)?"#":"")+s;i(e)?this.active[t]=e:console.warn("Theme",e+" is not a valid color.")},this.read=t=>this.active[t],this.parse=t=>s(t)?t:e(t)?JSON.parse(t):function(t){try{return(new DOMParser).parseFromString(t,"text/xml"),!0}catch(t){return!1}}(t)?function(t){const s=(new DOMParser).parseFromString(t,"text/xml");try{return{background:s.getElementById("background").getAttribute("fill"),f_high:s.getElementById("f_high").getAttribute("fill"),f_med:s.getElementById("f_med").getAttribute("fill"),f_low:s.getElementById("f_low").getAttribute("fill"),f_inv:s.getElementById("f_inv").getAttribute("fill"),b_high:s.getElementById("b_high").getAttribute("fill"),b_med:s.getElementById("b_med").getAttribute("fill"),b_low:s.getElementById("b_low").getAttribute("fill"),b_inv:s.getElementById("b_inv").getAttribute("fill")}}catch(t){console.warn("Theme","Incomplete SVG Theme",t)}}(t):void 0,this.drag=t=>{t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"},this.drop=t=>{t.preventDefault();const s=t.dataTransfer.files[0];s.name.indexOf(".svg")>-1&&this.read(s,this.load),t.stopPropagation()},this.read=(t,s)=>{const i=new FileReader;i.onload=t=>{s(t.target.result)},i.readAsText(t,"UTF-8")}};const k=function(){function t(t,s,i){return t<s?s:t>i?i:t}this.version=176,this.library=n,this.theme=new b(this),this.acels=new r(this),this.source=new h(this),this.history=new c(this),this.orca=new a(this.library),this.io=new y(this),this.cursor=new w(this),this.commander=new v(this),this.clock=new x(this),this.scale=window.devicePixelRatio,this.grid={w:8,h:8},this.tile={w:+localStorage.getItem("tilew")||10,h:+localStorage.getItem("tileh")||15},this.guide=!1,this.el=document.createElement("canvas"),this.context=this.el.getContext("2d"),this.install=t=>{t.appendChild(this.el),this.theme.install(t),this.theme.default={background:"#000000",f_high:"#ffffff",f_med:"#777777",f_low:"#444444",f_inv:"#000000",b_high:"#eeeeee",b_med:"#72dec2",b_low:"#444444",b_inv:"#ffb545"},this.acels.set("File","New","CmdOrCtrl+N",(()=>{this.reset()})),this.acels.set("File","Open","CmdOrCtrl+O",(()=>{this.source.open("orca",this.whenOpen,!0)})),this.acels.set("File","Import Modules","CmdOrCtrl+L",(()=>{this.source.load("orca")})),this.acels.set("File","Export","CmdOrCtrl+S",(()=>{this.source.write("orca","orca",""+this.orca,"text/plain")})),this.acels.set("File","Export Selection","CmdOrCtrl+Shift+S",(()=>{this.source.write("orca","orca",""+this.cursor.selection(),"text/plain")})),this.acels.set("Edit","Undo","CmdOrCtrl+Z",(()=>{this.history.undo()})),this.acels.set("Edit","Redo","CmdOrCtrl+Shift+Z",(()=>{this.history.redo()})),this.acels.add("Edit","cut"),this.acels.add("Edit","copy"),this.acels.add("Edit","paste"),this.acels.set("Edit","Select All","CmdOrCtrl+A",(()=>{this.cursor.selectAll()})),this.acels.set("Edit","Erase Selection","Backspace",(()=>{this.cursor.ins?(this.cursor.erase(),this.cursor.move(-1,0)):this[this.commander.isActive?"commander":"cursor"].erase()})),this.acels.set("Edit","Uppercase","CmdOrCtrl+Shift+U",(()=>{this.cursor.toUpperCase()})),this.acels.set("Edit","Lowercase","CmdOrCtrl+Shift+L",(()=>{this.cursor.toLowerCase()})),this.acels.set("Edit","Drag North","Alt+ArrowUp",(()=>{this.cursor.drag(0,1)})),this.acels.set("Edit","Drag East","Alt+ArrowRight",(()=>{this.cursor.drag(1,0)})),this.acels.set("Edit","Drag South","Alt+ArrowDown",(()=>{this.cursor.drag(0,-1)})),this.acels.set("Edit","Drag West","Alt+ArrowLeft",(()=>{this.cursor.drag(-1,0)})),this.acels.set("Edit","Drag North(Leap)","CmdOrCtrl+Alt+ArrowUp",(()=>{this.cursor.drag(0,this.grid.h)})),this.acels.set("Edit","Drag East(Leap)","CmdOrCtrl+Alt+ArrowRight",(()=>{this.cursor.drag(this.grid.w,0)})),this.acels.set("Edit","Drag South(Leap)","CmdOrCtrl+Alt+ArrowDown",(()=>{this.cursor.drag(0,-this.grid.h)})),this.acels.set("Edit","Drag West(Leap)","CmdOrCtrl+Alt+ArrowLeft",(()=>{this.cursor.drag(-this.grid.w,0)})),this.acels.set("Project","Find","CmdOrCtrl+J",(()=>{this.commander.start("find:")})),this.acels.set("Project","Inject","CmdOrCtrl+B",(()=>{this.commander.start("inject:")})),this.acels.set("Project","Toggle Commander","CmdOrCtrl+K",(()=>{this.commander.start()})),this.acels.set("Project","Run Commander","Enter",(()=>{this.commander.run()})),this.acels.set("Cursor","Toggle Insert Mode","CmdOrCtrl+I",(()=>{this.cursor.ins=!this.cursor.ins})),this.acels.set("Cursor","Toggle Block Comment","CmdOrCtrl+/",(()=>{this.cursor.comment()})),this.acels.set("Cursor","Trigger Operator","CmdOrCtrl+P",(()=>{this.cursor.trigger()})),this.acels.set("Cursor","Reset","Escape",(()=>{this.toggleGuide(!1),this.commander.stop(),this.clear(),this.clock.isPaused=!1,this.cursor.reset()})),this.acels.set("Move","Move North","ArrowUp",(()=>{this.cursor.move(0,1)})),this.acels.set("Move","Move East","ArrowRight",(()=>{this.cursor.move(1,0)})),this.acels.set("Move","Move South","ArrowDown",(()=>{this.cursor.move(0,-1)})),this.acels.set("Move","Move West","ArrowLeft",(()=>{this.cursor.move(-1,0)})),this.acels.set("Move","Move North(Leap)","CmdOrCtrl+ArrowUp",(()=>{this.cursor.move(0,this.grid.h)})),this.acels.set("Move","Move East(Leap)","CmdOrCtrl+ArrowRight",(()=>{this.cursor.move(this.grid.w,0)})),this.acels.set("Move","Move South(Leap)","CmdOrCtrl+ArrowDown",(()=>{this.cursor.move(0,-this.grid.h)})),this.acels.set("Move","Move West(Leap)","CmdOrCtrl+ArrowLeft",(()=>{this.cursor.move(-this.grid.w,0)})),this.acels.set("Move","Scale North","Shift+ArrowUp",(()=>{this.cursor.scale(0,1)})),this.acels.set("Move","Scale East","Shift+ArrowRight",(()=>{this.cursor.scale(1,0)})),this.acels.set("Move","Scale South","Shift+ArrowDown",(()=>{this.cursor.scale(0,-1)})),this.acels.set("Move","Scale West","Shift+ArrowLeft",(()=>{this.cursor.scale(-1,0)})),this.acels.set("Move","Scale North(Leap)","CmdOrCtrl+Shift+ArrowUp",(()=>{this.cursor.scale(0,this.grid.h)})),this.acels.set("Move","Scale East(Leap)","CmdOrCtrl+Shift+ArrowRight",(()=>{this.cursor.scale(this.grid.w,0)})),this.acels.set("Move","Scale South(Leap)","CmdOrCtrl+Shift+ArrowDown",(()=>{this.cursor.scale(0,-this.grid.h)})),this.acels.set("Move","Scale West(Leap)","CmdOrCtrl+Shift+ArrowLeft",(()=>{this.cursor.scale(-this.grid.w,0)})),this.acels.set("Clock","Play/Pause","Space",(()=>{this.cursor.ins?this.cursor.move(1,0):this.clock.togglePlay(!1)})),this.acels.set("Clock","Frame By Frame","CmdOrCtrl+F",(()=>{this.clock.touch()})),this.acels.set("Clock","Reset Frame","CmdOrCtrl+Shift+R",(()=>{this.clock.setFrame(0)})),this.acels.set("Clock","Incr. Speed",">",(()=>{this.clock.modSpeed(1)})),this.acels.set("Clock","Decr. Speed","<",(()=>{this.clock.modSpeed(-1)})),this.acels.set("Clock","Incr. Speed(10x)","CmdOrCtrl+>",(()=>{this.clock.modSpeed(10,!0)})),this.acels.set("Clock","Decr. Speed(10x)","CmdOrCtrl+<",(()=>{this.clock.modSpeed(-10,!0)})),this.acels.set("View","Toggle Retina","Tab",(()=>{this.toggleRetina()})),this.acels.set("View","Toggle Guide","CmdOrCtrl+G",(()=>{this.toggleGuide()})),this.acels.set("View","Incr. Col","]",(()=>{this.modGrid(1,0)})),this.acels.set("View","Decr. Col","[",(()=>{this.modGrid(-1,0)})),this.acels.set("View","Incr. Row","}",(()=>{this.modGrid(0,1)})),this.acels.set("View","Decr. Row","{",(()=>{this.modGrid(0,-1)})),this.acels.set("View","Zoom In","CmdOrCtrl+=",(()=>{this.modZoom(.0625)})),this.acels.set("View","Zoom Out","CmdOrCtrl+-",(()=>{this.modZoom(-.0625)})),this.acels.set("View","Zoom Reset","CmdOrCtrl+0",(()=>{this.modZoom(1,!0)})),this.acels.set("Midi","Play/Pause Midi","CmdOrCtrl+Space",(()=>{this.clock.togglePlay(!0)})),this.acels.set("Midi","Next Input Device","CmdOrCtrl+,",(()=>{this.clock.setFrame(0),this.io.midi.selectNextInput()})),this.acels.set("Midi","Next Output Device","CmdOrCtrl+.",(()=>{this.clock.setFrame(0),this.io.midi.selectNextOutput()})),this.acels.set("Midi","Refresh Devices","CmdOrCtrl+Shift+M",(()=>{this.io.midi.refresh()})),this.acels.set("Communication","Choose OSC Port","alt+O",(()=>{this.commander.start("osc:")})),this.acels.set("Communication","Choose UDP Port","alt+U",(()=>{this.commander.start("udp:")})),this.acels.install(window),this.acels.pipe(this.commander)},this.start=()=>{console.info("Client","Starting.."),console.info(""+this.acels),this.theme.start(),this.io.start(),this.history.bind(this.orca,"s"),this.history.record(this.orca.s),this.clock.start(),this.cursor.start(),this.reset(),this.modZoom(),this.update(),this.el.className="ready",this.toggleGuide()},this.reset=()=>{this.orca.reset(),this.resize(),this.source.new(),this.history.reset(),this.cursor.reset(),this.clock.play()},this.run=()=>{this.io.clear(),this.clock.run(),this.orca.run(),this.io.run(),this.update()},this.update=()=>{!0!==document.hidden&&(this.clear(),this.ports=this.findPorts(),this.drawProgram(),this.drawInterface(),this.drawGuide())},this.whenOpen=(t,s)=>{const i=s.trim().split(/\r?\n/),e=i[0].length,o=i.length,n=i.join("\n").trim();this.orca.load(e,o,n),this.history.reset(),this.history.record(this.orca.s),this.resize()},this.setGrid=(t,s)=>{this.grid.w=t,this.grid.h=s,this.update()},this.toggleRetina=()=>{this.scale=1===this.scale?window.devicePixelRatio:1,console.log("Client","Pixel resolution: "+this.scale),this.resize(!0)},this.toggleGuide=(t=null)=>{const s=null!==t?t:!0!==this.guide;s!==this.guide&&(console.log("Client","Toggle Guide: "+s),this.guide=s,this.update())},this.modGrid=(s=0,i=0)=>{const e=t(this.grid.w+s,4,16),o=t(this.grid.h+i,4,16);this.setGrid(e,o)},this.modZoom=(t=0,s=!1)=>{this.tile={w:s?10:this.tile.w*(t+1),h:s?15:this.tile.h*(t+1),ws:Math.floor(this.tile.w*this.scale),hs:Math.floor(this.tile.h*this.scale)},localStorage.setItem("tilew",this.tile.w),localStorage.setItem("tileh",this.tile.h),this.resize(!0)},this.isCursor=(t,s)=>t===this.cursor.x&&s===this.cursor.y,this.isMarker=(t,s)=>t%this.grid.w==0&&s%this.grid.h==0,this.isNear=(t,s)=>t>parseInt(this.cursor.x/this.grid.w)*this.grid.w-1&&t<=(1+parseInt(this.cursor.x/this.grid.w))*this.grid.w&&s>parseInt(this.cursor.y/this.grid.h)*this.grid.h-1&&s<=(1+parseInt(this.cursor.y/this.grid.h))*this.grid.h,this.isLocals=(t,s)=>!0===this.isNear(t,s)&&!0==(t%(this.grid.w/4)==0&&s%(this.grid.h/4)==0),this.isInvisible=(t,s)=>!("."!==this.orca.glyphAt(t,s)||this.isMarker(t,s)||this.cursor.selected(t,s)||this.isLocals(t,s)||this.ports[this.orca.indexAt(t,s)]||this.orca.lockAt(t,s)),this.findPorts=()=>{const t=new Array(this.orca.w*this.orca.h-1);for(const s of this.orca.runtime){if(this.orca.lockAt(s.x,s.y))continue;const i=s.getPorts();for(const s of i){t[this.orca.indexAt(s[0],s[1])]=s}}return t},this.makeTheme=t=>0===t?{bg:this.theme.active.b_med,fg:this.theme.active.f_low}:1===t?{fg:this.theme.active.b_med}:2===t?{fg:this.theme.active.b_high}:3===t?{bg:this.theme.active.b_high,fg:this.theme.active.f_low}:4===t?{bg:this.theme.active.b_inv,fg:this.theme.active.f_inv}:5===t?{fg:this.theme.active.f_med}:6===t?{fg:this.theme.active.b_inv}:7===t?{}:8===t?{bg:this.theme.active.b_low,fg:this.theme.active.f_high}:9===t?{bg:this.theme.active.b_inv,fg:this.theme.active.background}:10===t?{bg:this.theme.active.background,fg:this.theme.active.f_high}:11===t?{fg:this.theme.active.b_inv}:{fg:this.theme.active.f_low},this.clear=()=>{this.context.clearRect(0,0,this.el.width,this.el.height)},this.drawProgram=()=>{const t=this.cursor.read();for(let s=0;s<this.orca.h;s++)for(let i=0;i<this.orca.w;i++){if(this.isInvisible(i,s))continue;const e=this.orca.glyphAt(i,s),o="."!==e?e:this.isCursor(i,s)?this.clock.isPaused?"~":"@":this.isMarker(i,s)?"+":e;this.drawSprite(i,s,o,this.makeStyle(i,s,o,t))}},this.makeStyle=(t,s,i,e)=>{if(this.cursor.selected(t,s))return 4;const o=this.orca.lockAt(t,s);if(e===i&&!1===o&&"."!==e)return 6;if("*"===i&&!1===o)return 2;const n=this.ports[this.orca.indexAt(t,s)];return n?n[2]:!0===o?5:20},this.drawInterface=()=>{var t,s,i;this.write(""+this.cursor.inspect(),0*this.grid.w,this.orca.h,this.grid.w-1),this.write(`${this.cursor.x},${this.cursor.y}${this.cursor.ins?"+":""}`,1*this.grid.w,this.orca.h,this.grid.w,this.cursor.ins?1:2),this.write(`${this.cursor.w}:${this.cursor.h}`,2*this.grid.w,this.orca.h,this.grid.w),this.write(`${this.orca.f}f${this.clock.isPaused?"~":""}`,3*this.grid.w,this.orca.h,this.grid.w),this.write(""+this.io.inspect(this.grid.w),4*this.grid.w,this.orca.h,this.grid.w-1),this.write(this.orca.f<250?"< "+this.io.midi.toInputString():"",5*this.grid.w,this.orca.h,4*this.grid.w),!0===this.commander.isActive?this.write(`${this.commander.query}${this.orca.f%2==0?"_":""}`,0*this.grid.w,this.orca.h+1,4*this.grid.w):(this.write(this.orca.f<25?"ver"+this.version:Object.keys(this.source.cache).length+" mods",0*this.grid.w,this.orca.h+1,this.grid.w),this.write(`${this.orca.w}x${this.orca.h}`,1*this.grid.w,this.orca.h+1,this.grid.w),this.write(`${this.grid.w}/${this.grid.h}${10!==this.tile.w?" "+(this.tile.w/10).toFixed(1):""}`,2*this.grid.w,this.orca.h+1,this.grid.w),this.write(""+this.clock,3*this.grid.w,this.orca.h+1,this.grid.w,this.clock.isPuppet?3:this.io.midi.isClock?11:this.clock.isPaused?20:2),this.write(""+(t=Object.keys(this.orca.variables).join(""),s=this.orca.f,i=this.grid.w-1,t.length<i?t:t.slice(s%t.length)+t.substr(0,s%t.length)),4*this.grid.w,this.orca.h+1,this.grid.w-1),this.write(this.orca.f<250?"> "+this.io.midi.toOutputString():"",5*this.grid.w,this.orca.h+1,4*this.grid.w))},this.drawGuide=()=>{if(!0!==this.guide)return;const t=Object.keys(this.library).filter((t=>isNaN(t)));for(const s in t){const i=t[s],e=(new this.library[i]).info,o=this.orca.h-4,n=32*Math.floor(parseInt(s)/o)+2,r=parseInt(s)%o+2;this.write(i,n,r,99,3),this.write(e,n+2,r,99,10)}},this.drawSprite=(t,s,i,e)=>{const o=this.makeTheme(e);o.bg&&(this.context.fillStyle=o.bg,this.context.fillRect(t*this.tile.ws,s*this.tile.hs,this.tile.ws,this.tile.hs)),o.fg&&(this.context.fillStyle=o.fg,this.context.fillText(i,(t+.5)*this.tile.ws,(s+1)*this.tile.hs))},this.write=(t,s,i,e=50,o=2)=>{for(let n=0;n<t.length&&n<e;n++)this.drawSprite(s+n,i,t.substr(n,1),o)},this.resize=()=>{const t=window.innerWidth-60,s=window.innerHeight-(60+2*this.tile.h),i={w:Math.ceil(t/this.tile.w),h:Math.ceil(s/this.tile.h)},e=this.orca.bounds();i.w<e.w+1&&(i.w=e.w+1),i.h<e.h+1&&(i.h=e.h+1),this.crop(i.w,i.h),this.cursor.x>=i.w&&this.cursor.moveTo(i.w-1,this.cursor.y),this.cursor.y>=i.h&&this.cursor.moveTo(this.cursor.x,i.h-1);const o=this.tile.ws*this.orca.w,n=(this.tile.hs+this.tile.hs/5)*this.orca.h;o===this.el.width&&n===this.el.height||(console.log(`Resized to: ${this.orca.w}x${this.orca.h}`),this.el.width=o,this.el.height=n,this.el.style.width=Math.ceil(this.tile.w*this.orca.w)+"px",this.el.style.height=Math.ceil((this.tile.h+this.tile.h/5)*this.orca.h)+"px",this.context.textBaseline="bottom",this.context.textAlign="center",this.context.font=.75*this.tile.hs+"px input_mono_medium",this.update())},this.crop=(t,s)=>{let i=""+this.orca;s>this.orca.h?i=`${i}${("\n"+".".repeat(this.orca.w)).repeat(s-this.orca.h)}`:s<this.orca.h&&(i=(""+i).split(/\r?\n/).slice(0,s-this.orca.h).join("\n").trim()),t>this.orca.w?i=(""+i).split(/\r?\n/).map((s=>s+".".repeat(t-this.orca.w))).join("\n").trim():t<this.orca.w&&(i=(""+i).split(/\r?\n/).map((s=>s.substr(0,s.length+(t-this.orca.w)))).join("\n").trim()),this.history.reset(),this.orca.load(t,s,i,this.orca.f)},this.docs=()=>{let t="";const s=Object.keys(n).filter((t=>isNaN(t)));for(const i in s){const e=new this.library[s[i]],o=e.ports.input?Object.keys(e.ports.input).reduce(((t,s,i)=>t+" "+s),""):"";t+=`- \`${e.glyph.toUpperCase()}\` **${e.name}**${""!==o?"("+o.trim()+")":""}: ${e.info}.\n`}return t},window.addEventListener("dragover",(t=>{t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"})),window.addEventListener("drop",(t=>{t.preventDefault(),t.stopPropagation();for(const s of t.dataTransfer.files)s.name.indexOf(".orca")<0||(this.toggleGuide(!1),this.source.read(s,null,!0),this.commander.start("inject:"+s.name.replace(".orca","")))})),window.onresize=t=>{this.resize()}},C=window.client=new k;window.start=()=>{let t;C.install(document.body),C.start();let i=window.top.location.hash.slice(1);if(i.length)try{t=s().decompressFromEncodedURIComponent(i),C.whenOpen("",t)}catch(t){}document.addEventListener("keyup",(e=>{const o=C.orca.toString();o!==t&&(t=o,i=s().compressToEncodedURIComponent(t),window.top.history.replaceState(void 0,void 0,"#"+i))}))}})()})();